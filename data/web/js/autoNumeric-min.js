/**
* autoNumeric.js
* @author: Bob Knothe
* @author: Sokolov Yura aka funny_falcon
* @version: 1.7.5
*
* Created by Robert J. Knothe on 2010-10-25. Please report any bug at http://www.decorplanit.com/plugin/
* Created by Sokolov Yura on 2010-11-07. http://github.com/funny_falcon
*
* Copyright (c) 2011 Robert J. Knothe  http://www.decorplanit.com/plugin/
* Copyright (c) 2011 Sokolov Yura aka funny_falcon
*
* The MIT License (http://www.opensource.org/licenses/mit-license.php)
*
* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions.
*
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
*/
(function ($) {function getElementSelection(c){var b={};if(c.selectionStart===undefined){c.focus();var a=document.selection.createRange();b.length=a.text.length;a.moveStart("character",-c.value.length);b.end=a.text.length;b.start=b.end-b.length}else{b.start=c.selectionStart;b.end=c.selectionEnd;b.length=b.end-b.start}return b}function setElementSelection(c,d,a){if(c.selectionStart===undefined){c.focus();var b=c.createTextRange();b.collapse(true);b.moveEnd("character",a);b.moveStart("character",d);b.select()}else{c.selectionStart=d;c.selectionEnd=a}}function runCallbacks(a,b){$.each(b,function(d,f){if(typeof(f)==="function"){b[d]=f(a,b,d)}else{if(typeof(f)==="string"){var e=f.substr(0,4);if(e==="fun:"){var c=$.autoNumeric[f.substr(4)];if(typeof(c)==="function"){b[d]=$.autoNumeric[f.substr(4)](a,b,d)}else{b[d]=null}}else{if(e==="css:"){b[d]=$(f.substr(4)).val()}}}}})}function convertKeyToNumber(b,a){if(typeof(b[a])==="string"){b[a]*=1}}function autoCode(d,c){var g=$.extend({},$.fn.autoNumeric.defaults,c);if(d!=null){if($.metadata){g=$.extend(g,d.metadata())}runCallbacks(d,g);}var f=g.vMax.toString().split(".");var b=(!g.vMin&&g.vMin!==0)?[]:g.vMin.toString().split(".");convertKeyToNumber(g,"vMax");convertKeyToNumber(g,"vMin");convertKeyToNumber(g,"mDec");g.aNeg=g.vMin<0?"-":"";if(typeof(g.mDec)!=="number"){g.mDec=Math.max((f[1]?f[1]:"").length,(b[1]?b[1]:"").length)}if(g.altDec===null&&g.mDec>0){if(g.aDec==="."&&g.aSep!==","){g.altDec=","}else{if(g.aDec===","&&g.aSep!=="."){g.altDec="."}}}var a=g.aNeg?"([-\\"+g.aNeg+"]?)":"(-?)";g._aNegReg=a;g._skipFirst=new RegExp(a+"[^-"+(g.aNeg?"\\"+g.aNeg:"")+"\\"+g.aDec+"\\d].*?(\\d|\\"+g.aDec+"\\d)");g._skipLast=new RegExp("(\\d\\"+g.aDec+"?)[^\\"+g.aDec+"\\d]\\D*$");var e=(g.aNeg?g.aNeg:"-")+g.aNum+"\\"+g.aDec;if(g.altDec&&g.altDec!==g.aSep){e+=g.altDec}g._allowed=new RegExp("[^"+e+"]","gi");g._numReg=new RegExp(a+"(?:\\"+g.aDec+"?(\\d+\\"+g.aDec+"\\d+)|(\\d*(?:\\"+g.aDec+"\\d*)?))");return g}function autoStrip(c,e,d){if(e.aSign){while(c.indexOf(e.aSign)>-1){c=c.replace(e.aSign,"")}}c=c.replace(e._skipFirst,"$1$2");c=c.replace(e._skipLast,"$1");c=c.replace(e._allowed,"");if(e.altDec){c=c.replace(e.altDec,e.aDec)}var a=c.match(e._numReg);c=a?[a[1],a[2],a[3]].join(""):"";if(d){var b="^"+e._aNegReg+"0*(\\d"+(d==="leading"?")":"|$)");b=new RegExp(b);c=c.replace(b,"$1$2")}return c}function truncateDecimal(b,a,d){if(a&&d){var c=b.split(a);if(c[1]&&c[1].length>d){if(d>0){c[1]=c[1].substring(0,d);b=c.join(a)}else{b=c[0]}}}return b}function fixNumber(c,b,a){if(b&&b!=="."){c=c.replace(b,".")}if(a&&a!=="-"){c=c.replace(a,"-")}if(!c.match(/\d/)){c+="0"}return c}function presentNumber(c,b,a){if(a&&a!=="-"){c=c.replace("-",a)}if(b&&b!=="."){c=c.replace(".",b)}return c}function autoCheck(a,c){a=autoStrip(a,c);a=truncateDecimal(a,c.aDec,c.mDec);a=fixNumber(a,c.aDec,c.aNeg);var b=+a;return b>=c.vMin&&b<=c.vMax}function checkEmpty(b,c,a){if(b===""||b===c.aNeg){if(c.wEmpty==="zero"){return b+"0"}else{if(c.wEmpty==="sign"||a){return b+c.aSign}else{return b}}}return null}function autoGroup(c,g){c=autoStrip(c,g);var f=checkEmpty(c,g,true);if(f!==null){return f}var a="";if(g.dGroup===2){a=/(\d)((\d)(\d{2}?)+)$/}else{if(g.dGroup===4){a=/(\d)((\d{4}?)+)$/}else{a=/(\d)((\d{3}?)+)$/}}var e=c.split(g.aDec);if(g.altDec&&e.length===1){e=c.split(g.altDec)}var d=e[0];if(g.aSep){while(a.test(d)){d=d.replace(a,"$1"+g.aSep+"$2")}}if(g.mDec!==0&&e.length>1){if(e[1].length>g.mDec){e[1]=e[1].substring(0,g.mDec)}c=d+g.aDec+e[1]}else{c=d}if(g.aSign){var b=c.indexOf(g.aNeg)!==-1;c=c.replace(g.aNeg,"");c=g.pSign==="p"?g.aSign+c:c+g.aSign;if(b){c=g.aNeg+c}}return c}function autoRound(g,o,c,q){g=(g==="")?"0":g.toString();var b="";var k=0;var r="";var m=(typeof(q)==="boolean"||q===null)?(q?o:0):+q;var a=function(i){var s=m===0?(/(\.[1-9]*)0*$/):m===1?(/(\.\d[1-9]*)0*$/):new RegExp("(\\.\\d{"+m+"}[1-9]*)0*$");i=i.replace(s,"$1");if(m===0){i=i.replace(/\.$/,"")}return i};if(g.charAt(0)==="-"){r="-";g=g.replace("-","")}if(!g.match(/^\d/)){g="0"+g}if(r==="-"&&+g===0){r=""}if((+g)>0){g=g.replace(/^0*(\d)/,"$1")}var n=g.lastIndexOf(".");var j=n===-1?g.length-1:n;var l=(g.length-1)-j;if(l<=o){b=g;if(l<m){if(n===-1){b+="."}while(l<m){var d="000000".substring(0,m-l);b+=d;l+=d.length}}else{if(l>m){b=a(b)}else{if(l===0&&m===0){b=b.replace(/\.$/,"")}}}return r+b}var e=n+o;var f=+g.charAt(e+1);var h=g.substring(0,e+1).split("");var p=(g.charAt(e)===".")?(g.charAt(e-1)%2):(g.charAt(e)%2);if((f>4&&c==="S")||(f>4&&c==="A"&&r==="")||(f>5&&c==="A"&&r==="-")||(f>5&&c==="s")||(f>5&&c==="a"&&r==="")||(f>4&&c==="a"&&r==="-")||(f>5&&c==="B")||(f===5&&c==="B"&&p===1)||(f>0&&c==="C"&&r==="")||(f>0&&c==="F"&&r==="-")||(f>0&&c==="U")){for(k=(h.length-1);k>=0;k-=1){if(h[k]!=="."){h[k]=+h[k]+1;if(h[k]<10){break}else{if(k>0){h[k]="0"}}}}}h=h.slice(0,e+1);b=a(h.join(""));return r+b}function autoNumericHolder(b,a){this.options=a;this.that=b;this.$that=$(b);this.formatted=false;this.io=autoCode(this.$that,this.options);this.value=b.value}autoNumericHolder.prototype={init:function(a){this.value=this.that.value;this.io=autoCode(this.$that,this.options);this.ctrlKey=a.ctrlKey;this.cmdKey=a.metaKey;this.shiftKey=a.shiftKey;this.selection=getElementSelection(this.that);if(a.type==="keydown"||a.type==="keyup"){this.kdCode=a.keyCode}this.which=a.which;this.processed=false;this.formatted=false},setSelection:function(c,a,b){c=Math.max(c,0);a=Math.min(a,this.that.value.length);this.selection={start:c,end:a,length:a-c};if(b===undefined||b){setElementSelection(this.that,c,a)}},setPosition:function(b,a){this.setSelection(b,b,a)},getBeforeAfter:function(){var b=this.value;var c=b.substring(0,this.selection.start);var a=b.substring(this.selection.end,b.length);return[c,a]},getBeforeAfterStriped:function(){var a=this.getBeforeAfter();a[0]=autoStrip(a[0],this.io);a[1]=autoStrip(a[1],this.io);return a},normalizeParts:function(e,c){var f=this.io;c=autoStrip(c,f);var d=c.match(/^\d/)?true:"leading";e=autoStrip(e,f,d);if((e===""||e===f.aNeg)){if(c>""){c=c.replace(/^0*(\d)/,"$1")}}var b=e+c;if(f.aDec){var a=b.match(new RegExp("^"+f._aNegReg+"\\"+f.aDec));if(a){e=e.replace(a[1],a[1]+"0");b=e+c}}if(f.wEmpty==="zero"&&(b===f.aNeg||b==="")){e+="0"}return[e,c]},setValueParts:function(e,c){var f=this.io;var d=this.normalizeParts(e,c);var b=d.join("");var a=d[0].length;if(autoCheck(b,f)){b=truncateDecimal(b,f.aDec,f.mDec);if(a>b.length){a=b.length}this.value=b;this.setPosition(a,false);return true}return false},signPosition:function(){var f=this.io,d=f.aSign,c=this.that;if(d){var b=d.length;if(f.pSign==="p"){var e=f.aNeg&&c.value&&c.value.charAt(0)===f.aNeg;return e?[1,b+1]:[0,b]}else{var a=c.value.length;return[a-b,a]}}else{return[1000,-1]}},expandSelectionOnSign:function(b){var a=this.signPosition();var c=this.selection;if(c.start<a[1]&&c.end>a[0]){if((c.start<a[0]||c.end>a[1])&&this.value.substring(Math.max(c.start,a[0]),Math.min(c.end,a[1])).match(/^\s*$/)){if(c.start<a[0]){this.setSelection(c.start,a[0],b)}else{this.setSelection(a[1],c.end,b)}}else{this.setSelection(Math.min(c.start,a[0]),Math.max(c.end,a[1]),b)}}},checkPaste:function(){if(this.valuePartsBeforePaste!==undefined){var b=this.getBeforeAfter();var a=this.valuePartsBeforePaste;delete this.valuePartsBeforePaste;b[0]=b[0].substr(0,a[0].length)+autoStrip(b[0].substr(a[0].length),this.io);if(!this.setValueParts(b[0],b[1])){this.value=a.join("");this.setPosition(a[0].length,false)}}},skipAllways:function(f){var a=this.kdCode,h=this.which,g=this.ctrlKey,b=this.cmdKey;if(a===17&&f.type==="keyup"&&this.valuePartsBeforePaste!==undefined){this.checkPaste();return false}if((a>=112&&a<=123)||(a>=91&&a<=93)||(a>=9&&a<=31)||(a<8&&(h===0||h===a))||a===144||a===145||a===45){return true}if((g||b)&&a===65){return true}if((g||b)&&(a===67||a===86||a===88)){if(f.type==="keydown"){this.expandSelectionOnSign()}if(a===86){if(f.type==="keydown"||f.type==="keypress"){if(this.valuePartsBeforePaste===undefined){this.valuePartsBeforePaste=this.getBeforeAfter()}}else{this.checkPaste()}}return f.type==="keydown"||f.type==="keypress"||a===67}if(g||b){return true}if(a===37||a===39){var c=this.io.aSep,i=this.selection.start,d=this.that.value;if(f.type==="keydown"&&c&&!this.shiftKey){if(a===37&&d.charAt(i-2)===c){this.setPosition(i-1)}else{if(a===39&&d.charAt(i)===c){this.setPosition(i+1)}}}return true}if(a>=34&&a<=40){return true}return false},processAllways:function(){var a;if(this.kdCode===8||this.kdCode===46){if(!this.selection.length){a=this.getBeforeAfterStriped();if(this.kdCode===8){a[0]=a[0].substring(0,a[0].length-1)}else{a[1]=a[1].substring(1,a[1].length)}this.setValueParts(a[0],a[1])}else{this.expandSelectionOnSign(false);a=this.getBeforeAfterStriped();this.setValueParts(a[0],a[1])}return true}return false},processKeypress:function(){var e=this.io;var a=String.fromCharCode(this.which);var d=this.getBeforeAfterStriped();var c=d[0],b=d[1];if(a===e.aDec||(e.altDec&&a===e.altDec)||((a==="."||a===",")&&this.kdCode===110)){if(!e.mDec||!e.aDec){return true}if(e.aNeg&&b.indexOf(e.aNeg)>-1){return true}if(c.indexOf(e.aDec)>-1){return true}if(b.indexOf(e.aDec)>0){return true}if(b.indexOf(e.aDec)===0){b=b.substr(1)}this.setValueParts(c+e.aDec,b);return true}if(a==="-"||a==="+"){if(!e.aNeg){return true}if(c===""&&b.indexOf(e.aNeg)>-1){c=e.aNeg;b=b.substring(1,b.length)}if(c.charAt(0)===e.aNeg){c=c.substring(1,c.length)}else{c=(a==="-")?e.aNeg+c:c}this.setValueParts(c,b);return true}if(a>="0"&&a<="9"){if(e.aNeg&&c===""&&b.indexOf(e.aNeg)>-1){c=e.aNeg;b=b.substring(1,b.length)}this.setValueParts(c+a,b);return true}return true},formatQuick:function(){var h=this.io;var f=this.getBeforeAfterStriped();var e=autoGroup(this.value,this.io);var a=e.length;if(e){var c=f[0].split("");var b;for(b=0;b<c.length;b+=1){if(!c[b].match("\\d")){c[b]="\\"+c[b]}}var g=new RegExp("^.*?"+c.join(".*?"));var d=e.match(g);if(d){a=d[0].length;if(((a===0&&e.charAt(0)!==h.aNeg)||(a===1&&e.charAt(0)===h.aNeg))&&h.aSign&&h.pSign==="p"){a=this.io.aSign.length+(e.charAt(0)==="-"?1:0)}}else{if(h.aSign&&h.pSign==="s"){a-=h.aSign.length}}}this.that.value=e;this.setPosition(a);this.formatted=true}};function getData(a){var b=a.data("autoNumeric");if(!b){b={};a.data("autoNumeric",b)}return b}function getHolder(a,b){var d=getData(a);var c=d.holder;if(c===undefined&&b){c=new autoNumericHolder(a.get(0),b);d.holder=c}return c}function getOptions(a){var b=a.data("autoNumeric");if(b&&b.holder){return b.holder.options}return{}}function onInit(b){b=b||{};var a=$(this),c=getHolder(a,b);if(c.io.aForm&&(this.value||c.io.wEmpty!=="empty")){a.autoNumericSet(a.autoNumericGet(b),b)}}function onKeyDown(c){var a=$(c.target),b=getHolder(a);b.init(c);if(b.skipAllways(c)){b.processed=true;return true}if(b.processAllways()){b.processed=true;b.formatQuick();c.preventDefault();return false}else{b.formatted=false}return true}function onKeyPress(c){var a=$(c.target),b=getHolder(a);var d=b.processed;b.init(c);if(b.skipAllways(c)){return true}if(d){c.preventDefault();return false}if(b.processAllways()||b.processKeypress()){b.formatQuick();c.preventDefault();return false}else{b.formatted=false}}function onKeyUp(d){var a=$(d.target),b=getHolder(a);b.init(d);var c=b.skipAllways(d);b.kdCode=0;delete b.valuePartsBeforePaste;if(c){return true}if(this.value===""){return true}if(!b.formatted){b.formatQuick()}}function onFocusIn(d){var a=$(d.target),c=getHolder(a);c.inVal=a.val();var b=checkEmpty(c.inVal,c.io,true);if(b!==null){a.val(b)}}function onFocusOut(g){var b=$(g.target),c=getHolder(b);var h=c.io,f=b.val(),a=f;if(f!==""){f=autoStrip(f,h);if(checkEmpty(f,h)===null&&autoCheck(f,h)){f=fixNumber(f,h.aDec,h.aNeg);f=autoRound(f,h.mDec,h.mRound,h.aPad);f=presentNumber(f,h.aDec,h.aNeg)}else{f=""}}var d=checkEmpty(f,h,false);if(d===null){d=autoGroup(f,h)}if(d!==a){b.val(d)}if(d!==c.inVal){b.change();delete c.inVal}}$.fn.autoNumeric=function(a){return this.each(function(){onInit.call(this,a)}).unbind(".autoNumeric").bind({"keydown.autoNumeric":onKeyDown,"keypress.autoNumeric":onKeyPress,"keyup.autoNumeric":onKeyUp,"focusin.autoNumeric":onFocusIn,"focusout.autoNumeric":onFocusOut})};function autoGet(a){if(typeof(a)==="string"){a=a.replace(/\[/g,"\\[").replace(/\]/g,"\\]");a="#"+a.replace(/(:|\.)/g,"\\$1")}return $(a)}$.autoNumeric={};$.aafwStripNumber=function(b){var a;if(arguments[1]&&typeof(arguments[1])==="object"){a=$.extend({},a,arguments[1])}var c=autoCode(null,a);b=autoStrip(b,c);b=fixNumber(b,c.aDec,c.aNeg);if(+b===0){b="0"}return b};$.autoNumeric.Strip=function(d){var a=autoGet(d);var c=getOptions(a);if(arguments[1]&&typeof(arguments[1])==="object"){c=$.extend({},c,arguments[1])}var e=autoCode(a,c);var b=autoGet(d).val();b=autoStrip(b,e);b=fixNumber(b,e.aDec,e.aNeg);if(+b===0){b="0"}return b};$.aafwFormatNumber=function(b){var a;if(arguments[1]&&typeof(arguments[1])==="object"){a=$.extend({},a,arguments[1])}var c=autoCode(null,a);b=autoRound(b,c.mDec,c.mRound,c.aPad);b=presentNumber(b,c.aDec,c.aNeg);if(!autoCheck(b,c)){b=autoRound("",c.mDec,c.mRound,c.aPad)}return autoGroup(b,c)};$.autoNumeric.Format=function(d,c){var a=autoGet(d);var b=getOptions(a);if(arguments[2]&&typeof(arguments[2])==="object"){b=$.extend({},b,arguments[2])}c.toString();var e=autoCode(a,b);c=autoRound(c,e.mDec,e.mRound,e.aPad);c=presentNumber(c,e.aDec,e.aNeg);if(!autoCheck(c,e)){c=autoRound("",e.mDec,e.mRound,e.aPad)}return autoGroup(c,e)};$.fn.autoNumericGet=function(){if(arguments[0]){return $.autoNumeric.Strip(this,arguments[0])}return $.autoNumeric.Strip(this)};$.fn.autoNumericSet=function(a){if(arguments[1]){switch(this.get(0).tagName){case"input":return this.val($.autoNumeric.Format(this,a,arguments[1]));default:return this.html($.autoNumeric.Format(this,a,arguments[1]))}}switch(this.get(0).tagName){case"input":return this.val($.fn.autoNumeric.Format(this,a));default:return this.html($.fn.autoNumeric.Format(this,a))}};$.autoNumeric.defaults={aNum:"0123456789",aSep:",",dGroup:"3",aDec:".",altDec:null,aSign:"",pSign:"p",vMax:"999999999.99",vMin:"0.00",mDec:null,mRound:"S",aPad:true,wEmpty:"empty",aForm:false};$.fn.autoNumeric.defaults=$.autoNumeric.defaults;$.fn.autoNumeric.Strip=$.autoNumeric.Strip;$.fn.autoNumeric.Format=$.autoNumeric.Format;})(jQuery);
